---
import SectionRendererAnimalList from '@shared/components/sections/SectionRendererAnimalList.astro';
import SectionRendererHero from '@shared/components/sections/SectionRendererHero.astro';
import SectionRendererTitle from '@shared/components/sections/SectionRendererTitle.astro';
import type { CmsArticle, SectionType } from 'sheltify-lib/article-types.ts';
import SectionRendererText from './sections/SectionRendererText.astro';
import SectionRendererImages from './sections/SectionRendererImages.astro';

interface Props {
  article: CmsArticle;
  isDraft: boolean,
}

const { article, isDraft } = Astro.props;
const fullWidthSections: SectionType[] = ['hero'];

let rowindex = 0;


const hasTopHero = article.Structure.Rows[0]?.Sections.length == 1 && article.Structure.Rows[0].Sections[0].SectionType == 'hero';
const topPadding = hasTopHero ? -16 : 48;

const cssClasses = ['themable', 'article', 'sui', 'flex-y'];
if (isDraft) {
  cssClasses.push('draft');
}

---
{ isDraft && <div class="sui wrapper p-1 mt-2 draft-info">Artikel nicht publiziert</div>}
<div style={'margin-top: ' + topPadding + 'px'} class:list={cssClasses}>

{
  article.Structure.Rows.map(row =>
    {
      // if a hero is the first row, we need negate of the initial top padding so it's placed right below the header
      const isTopHero = rowindex == 0 && row.Sections.length == 1 && row.Sections[0].SectionType == 'hero';
      rowindex++;
      const isFullWidth = row.Sections.length == 1 && fullWidthSections.includes(row.Sections[0].SectionType);
      const sections = row.Sections.map(section => {
        let comp;
        switch (section.SectionType) {
          case 'text':
            comp = <SectionRendererText section={section}/>;
            break;
          case 'title':
            comp = <SectionRendererTitle section={section}/>;
            break;
          case 'separator-x':
            comp = <hr/>;
            break;
          case 'hero':
            comp = <SectionRendererHero isTopHero={isTopHero} section={section}/>;
            break;
          case 'animal-list':
            comp = <SectionRendererAnimalList section={section}/>;
            break;
          case 'image':
            comp = <SectionRendererImages section={section}/>;
            break;
          default:
            comp = <div>Sektionstyp nicht unterst√ºtzt</div>;
            break;
          }
        return <div style={ (`width: ${100 / row.Sections.length}%; `)} class={'section section-' + section.SectionType}>{comp}</div>;
        })
      return <div class={'row sui flex-x wrap' +  (isFullWidth ? ' full-width' : '')}>{sections}</div>
      }
    )
  }
</div>

<script>
  const draftArticle = document.querySelector<HTMLElement>('.article.draft')!;

  if(draftArticle) {
    const showDraftQuery = new URLSearchParams(window.location.search).get('showDraft');
    if (showDraftQuery === 'true') {
      draftArticle.classList.remove('draft');
    }
  }
</script>

<style is:global lang="scss">
  .draft-info {
    background: #ffeab0;
  }
  .article {
    &.draft {
      display: none !important;
    }
    .row {

      &:not(.full-width) {
        width: var(--wrapper-width);
        max-width: 100%;
        margin-left: auto;
        margin-right: auto;
      }
    }

    .section {
      flex-grow: 1;
      padding: 16px;
      min-width: 300px;
    }

    .section-text {
      p {
        min-height: 1rem;
      }
    }

    .section-separator-x hr {
      border: none;
      background-color: #ddd;
      height: 1.5px;
      margin: 1.5rem 0;
    }

    .section-hero {
      width: 100dvw;
      left: 0;
    }
  }
</style>
