<div class="sui flex-x jc-end grow-1 gap-2">
  <button class="grow-1" (click)="save()">Speichern</button>
  <button (click)="isPreviewMode.set(!isPreviewMode())" [class]="isPreviewMode() ? 'primary' : 'secondary'"><ng-icon name="bootstrapEye"/></button>
</div>

<div class="sui flex-y grow-1" [class.dragMode]="movedItem()">
  <div (click)="addSectionAtNewRow(0)" (mouseup)="moveToNewRow(0)" class="move-to-row"></div>

  @if (article(); as article) {
    @for (row of article.Structure.Rows; track row) {
      @let iRow = $index;
      <div class="article-row sui flex-x jc-stretch" [class.preview]="isPreviewMode()">
        <div (mouseup)="moveToColumn(iRow,0)" (click)="addSectionAt(iRow, 0)" class="move-to-column"></div>
        @for (section of row.Sections; track section) {
          @let iColumn = $index;
          @let numSections = row.Sections.length;
          @let gapsWidth = 34 * (numSections + 1);
          <div [style]="'width: calc(' + (100 / numSections) + '% - ' + gapsWidth + 'px)' " class="sui flex-y grow-1" (click)="editSection(articleColumn, $event)">

            <div #articleColumn class="article-column sui grow-1">

              <div class="section-titlebar sui flex-x px-1 gap-1 ai-center">
                <b class="sui grow-1 py-1">{{ sectionLabels.get(section.SectionType) ?? 'Sektion' }}</b>
                <button (mousedown)="enterMoveMode(iRow, iColumn, section)" class="move-button small">verschieben</button>
                <ng-icon class="x" (click)="deleteSection(iRow, iColumn)" name="bootstrapX" size="22px"/>
              </div>
              <div class="section-content">
                @let renderedSectionsVal = renderedSections();
                <div class="section-preview" [innerHTML]="renderedSectionsVal ? renderedSectionsVal[iRow][iColumn] : ''"></div>
                <div class="section-editor">
                  @switch (section.SectionType) {
                    @case ('title') {<app-section-editor-title [section]="section"/>}
                    @case ('text') {<app-section-editor-text [section]="section"/>}
                    @case ('image') {<app-section-editor-images [section]="section"/>}
                    @case ('animal-list') {<app-section-editor-animal-list [section]="section" (triggerRerender)="triggerRerender()"/>}
                    @case ('html') {<app-section-editor-html [section]="section"/>}
                  }
                </div>
              </div>
            </div>

          </div>
          <div (mouseup)="moveToColumn(iRow, iColumn + 1)" (click)="addSectionAt(iRow, iColumn + 1)" class="move-to-column"></div>
        }
      </div>
      <div (click)="addSectionAtNewRow(iRow + 1)" (mouseup)="moveToNewRow(iRow + 1)" class="move-to-row"></div>
    }
  }
</div>

